<!doctype html>
<html>
<head>
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
  <meta content="utf-8" http-equiv="encoding">
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body {
      margin: 0px;
      width: 100%;
      height: 100%;
    }
    canvas#canvas {
      cursor: none;
      position: absolute;
      top: 0px;
      left: 0px;
    }
    .button {
      height: 50px;
      width: 50px;
      position: absolute;
      top: 10px;
      font-family: sans-serif;
      font-size: 24px;
      background: rgba(50, 50, 50, 0.9);
      color: white;
      cursor: pointer;
      border-radius: 2px;
      line-height: 50px;
      text-align: center;
    }
    .button img {
      margin-top: 13px;
    }
    #mode {
      left: 10px;
    }
    #clear {
      left: 10px;
    }
    #save {
      left: 80px;
    }
    #cursor {
      left: 150px;
    }
    #texture {
      left: 290px;
    }
    .noselect {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
  </style>
</head>

<body>
  <!-- Canvas -->
  <canvas id="canvas" class="noselect"></canvas>
  <!-- Buttons -->
  <div id="clear" class="button noselect"><img src="img/paper-24.png"/></div>
  <div id="save" class="button noselect"><img src="img/save-24.png"/></div>
  <div id="cursor" class="button noselect"><img id="cursor-icon" src="img/cursor-24-75.png"/></div>
</body>

<script src="ploma.js"></script>

<script>
  "use strict";

  var socket = io.connect("http://127.0.0.1:8080");

  // DOM
  var canvas;
  var save;
  var clear;
  var cursor;

  // State
  var sampling = 2;
  var ploma = null;
  var w;// = 1300;
  var h;// = 1000;
  var isDrawing = false;

  // Red Pixel
  var r = new Uint8ClampedArray(16);
  var rid;
  r[0] = 255;
  r[3] = 255;
  r[4] = 255;
  r[7] = 255;
  r[8] = 255;
  r[11] = 255;
  r[12] = 255;
  r[15] = 255;

  /////////////
  // ONLOAD
  /////////////
  window.onload = function() {

    // load DOM elements
    canvas = document.getElementById("canvas");
    canvas.setAttribute("width", window.innerWidth);
    canvas.setAttribute("height", window.innerHeight);
    save = document.getElementById("save");
    clear = document.getElementById("clear");
    cursor = document.getElementById("cursor");

    // populate red pixel
    rid = canvas.getContext("2d").createImageData(2, 2);
    rid.data.set(r);

    // load Ploma onto canvas and clear it
    ploma = new Ploma(canvas);
    ploma.clear();

    ////////////
    // BUTTONS
    ////////////
    save.onclick = function(e) {
      window.open(canvas.toDataURL());
    };

    clear.onclick = function(e) {
      ploma.clear();
    };

    cursor.onclick = function(e) {
      // TODO: UPDATE CHECKBOX OR IMAGE ON BUTTON
      if(canvas.style.cursor === "none") {
        document.getElementById("cursor-icon").setAttribute("src", "img/cursor-24.png");
        canvas.style.cursor = "crosshair";
      } else {
        document.getElementById("cursor-icon").setAttribute("src", "img/cursor-24-75.png");
        canvas.style.cursor = "none";
      }
    };

    window.onresize = function(e) {
      ploma.resize(window.innerWidth, window.innerHeight);
    };


    ////////////
    // Drawing
    ////////////

    socket.on("down", function(data) {
      isDrawing = true;

      ploma.beginStroke(
        data.x,
        data.y,
        0.9
      );
    });

    socket.on("move", function(data) {
      if (!isDrawing) {
        return;
      }

      ploma.extendStroke(
        data.x,
        data.y,
        0.9
      );
    });

    socket.on("up", function(data) {
      isDrawing = false;

      ploma.endStroke(
        data.x,
        data.y,
        0.9
      );
    });
  };

</script>

</html>
